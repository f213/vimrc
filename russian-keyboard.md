# Единственный способ переключать раскладку Vim на маке

Свежеустановленный MacVim использует системный метод переключения раскладок —
<kbd>⌘</kbd>+<kbd>Space</kbd>. У этого метода есть большой минус:
команды модального режима работают только на английском языке.
Редактор не поймет, что вы командуете `3dd`, когда увидит `3вв`.

Когда я работал под линуксом, язык у меня переключался при помощи капслока во
всех окнах. Пальцы привыкли нажимать капс перед каждым вводом команды
редактора. Но это — костыль. Vim нужен, чтобы экономить нажатия клавиш,
а не требовать лишнего переключения, потому что не может догадаться, чего я от
него хочу.

Очевидный способ заставить vim понимать `вв` как `dd` —
это использовать русский keymap в `.vimrc`:

```vimL
set keymap=russian-jcukenwin
set iminsert=0
set imsearch=0
```

Переключение раскладок будет происходить по
<kbd>Ctrl</kbd>+<kbd>^</kbd>, а команды модального режима будут работать
независимо от раскладки. Правда этот костыль недалеко ушел от первого — все
равно придется учить отдельный способ переключения для редактора.

На помощь приходит [Karabiner](https://pqrs.org/osx/karabiner/). С его помощью
можно перемапить <kbd>⌘</kbd>+<kbd>Space</kbd>, чтобы vim воспринимал его как
собственный шорткат. Установите Karabiner и добавьте в `private.xml`:

```xml
<appdef>
    <appname>MacVim</appname>
    <equal>org.vim.MacVim</equal>
</appdef>
<item>
    <name>vim: Cmd-space changes keyboard layout in vim style(Ctrl-^)</name>
    <identifier>private.cmd-space-to-ctrl-^</identifier>
    <only>MacVim</only>
    <autogen>__KeyToKey__ KeyCode::SPACE, ModifierFlag::COMMAND_L, KeyCode::KEY_6, ModifierFlag::CONTROL_L</autogen>
</item>
```
Теперь переключение в vim будет происходить по системному сочетанию
<kbd>⌘</kbd>+<kbd>Space</kbd>, а в модальном режиме команды будут работать
независимо от раскладки.

Остается последний штрих — если вы переключите раскладку с английского на
русский вне онка vim, а затем вернетесь,
то vim будет получать ввод на русском: вы не сможете вернуться на английский
язык.

Чтобы сохранить магию, установите плагин [Keyboard Layout
Switcher](https://github.com/porqz/KeyboardLayoutSwitcher). Когда vim теряет фокус, плагин
запоминает раскладку, и возвращает ее как только фокус возвращается.

Таким образом вы получите полную эмуляцию системного переключения в vim и не
потеряете команды модального режима.